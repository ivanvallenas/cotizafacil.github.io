<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Cotiza Fácil</title>
    <link rel="stylesheet" type="text/css" href="css/lista_materiales.css">
    <link rel="stylesheet" type="text/css" href="css/main_elements.css">

</head>
<body>

  <section class="container2">

    <div id="btns_de_listas" class="container2" >
            <button id="lista_solicitudes" class="main_buttons" onclick="window.location='lista_solicitudes.html'""  >Cotizar</button>
            <!--<button id="lista_cotizaciones_realizadas" class="main_buttons"  onclick="window.location='lista_cotizaciones.html'"">Tus Ofertas</button>-->
            <button id="lista_materiales" class="main_buttons"  onclick="window.location='lista_materiales.html'"" style="background-color:hsl(24, 72%, 52%)">Tus Materiales</button>
    </div>

    <div class="container2">
          <h1>Nombre de tu ferretería</h1>
          <input class="main_inputs" type="text" id="nombre_ferreteria">
          <h1>Teléfono</h1>
          <input class="main_inputs" type="text" id="telefono">
          <h1>Dirección</h1>
          <input class="main_inputs" type="text" id="direccion">
    </div>


    <section class="container">
          <h1>Lista de materiales</h1>

          <div class="table" id="tabla_materiales">
            <div class="titulo_columna"><p>Material y marca</p></div>
            <div class="titulo_columna"><p>Precio unitario</p></div>
          </div>
      
    <button class="main_buttons" id="btn_anadir_material"> Añadir material</button>
    </section>
    <button class="main_buttons" id="btn_actualizar_datos"> Actualizar Datos</button>
  </section>   

  <script type="module">

    import {db} from "./js/firebase.js";
    import {getDatabase,set, get, update, remove, ref, child}
    from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js"
    const usuario = sessionStorage.getItem("usuario")

    let ferreteria_pruductos = []
    ferreteria_pruductos =JSON.parse(sessionStorage.getItem("ferreteria_pruductos"))
    let ferreteria_precios = []
    ferreteria_precios =JSON.parse(sessionStorage.getItem("ferreteria_precios"))
    let ferreteria_materiales = []
    ferreteria_materiales =JSON.parse(sessionStorage.getItem("ferreteria_materiales"))
    let ferreteria_marcas = []
    ferreteria_marcas =JSON.parse(sessionStorage.getItem("ferreteria_marcas"))


    console.log(ferreteria_materiales)
    console.log(ferreteria_marcas)
    console.log(ferreteria_precios)



    var nombre_ferreteria = document.getElementById("nombre_ferreteria")
    var telefono = document.getElementById("telefono")
    var direccion = document.getElementById("direccion")

    nombre_ferreteria.value = sessionStorage.getItem("nombre_ferreteria")
    telefono.value = sessionStorage.getItem("telefono")
    direccion.value = sessionStorage.getItem("direccion")

    let lista_materiales = ['Elegir material','Elegir material.','Alambre de amarre -  (kg)', 'Arena - fina (m3)', 'Arena corriente -  (m3)', 'Calamina ondu - N.28 1m *2m (unid)', 'Calamina plana - Plana N.28 2*1 (unid)', 'Cemento blanco -  (unid)', 'Cemento cola -  (unid)', 'Clavo - 2 pulg (kg)', 'Clavo - 3 pulg (kg)', 'Clavo - 4 pulg (kg)', 'Clavo calamina -  (kg)', 'Estuco -  (unid)', 'Fierro - 1/4 pulg (unid)', 'Fierro - 1/8 pulg (unid)', 'Fierro de media -  (unid)', 'Ladrillo - 18 huecos (unid)', 'Ladrillo  - 6 huecos (unid)', 'Piedra - manzano (m3)', 'Piedra - chancada (m3)', 'Tubo  - berman 1 pulg (unid)', 'Tubo  - berman 3/4 pulg (unid)', 'Tubo  - De cemento 8 pulg (unid)', 'Tubo  - PVC 3 pulg (unid)', 'Tubo  - PVC 4 pulg (unid)', 'Tubo  - PVC 5 pulg (unid)']
    let lista_materiales_valores = [' ','Elegir material.','Alambre de amarre -  (kg)', 'Arena - fina (m3)', 'Arena corriente -  (m3)', 'Calamina ondu - N.28 1m *2m (unid)', 'Calamina plana - Plana N.28 2*1 (unid)', 'Cemento blanco -  (unid)', 'Cemento cola -  (unid)', 'Clavo - 2 pulg (kg)', 'Clavo - 3 pulg (kg)', 'Clavo - 4 pulg (kg)', 'Clavo calamina -  (kg)', 'Estuco -  (unid)', 'Fierro - 1/4 pulg (unid)', 'Fierro - 1/8 pulg (unid)', 'Fierro de media -  (unid)', 'Ladrillo - 18 huecos (unid)', 'Ladrillo  - 6 huecos (unid)', 'Piedra - manzano (m3)', 'Piedra - chancada (m3)', 'Tubo  - berman 1 pulg (unid)', 'Tubo  - berman 3/4 pulg (unid)', 'Tubo  - De cemento 8 pulg (unid)', 'Tubo  - PVC 3 pulg (unid)', 'Tubo  - PVC 4 pulg (unid)', 'Tubo  - PVC 5 pulg (unid)']
    let lista_marcas = ['Cualquier marca','Acelormittal', 'Acergal', 'Acero las lomas', 'Aceros Arequipa', 'Adhere forte', 'Calamina condor ', 'Campero', 'Cemento camba', 'Cemento ecebol', 'Cemento viacha', 'Cemento yura', 'Ceramica avaroa', 'Ceramica blanca', 'Clavos corinsa', 'Coboce', 'Dismat', 'Estuco vichaya', 'Incerpatzi', 'Incerpaz', 'Pinguino', 'Stick mix', 'Tigre']
    let lista_marcas_valores = ['Cualquier marca','Acelormittal', 'Acergal', 'Acero las lomas', 'Aceros Arequipa', 'Adhere forte', 'Calamina condor ', 'Campero', 'Cemento camba', 'Cemento ecebol', 'Cemento viacha', 'Cemento yura', 'Ceramica avaroa', 'Ceramica blanca', 'Clavos corinsa', 'Coboce', 'Dismat', 'Estuco vichaya', 'Incerpatzi', 'Incerpaz', 'Pinguino', 'Stick mix', 'Tigre']

    function crear_select(array, array_valores){
      var select = document.createElement("select");
      for (var i = 0; i < array.length; i++) {
          var option = document.createElement("option");
          option.value = array_valores[i];
          option.text = array[i];
          select.appendChild(option);
      }
      return select;
    }

    function crear_linea_material(materiales, materiales_valores,marcas,marcas_valores, tabla,i,material_extra){

      var div_material_marca = document.createElement("div")
      div_material_marca.className="item2"

      var div_material = document.createElement("div")
      var select_material = crear_select(materiales,materiales_valores)
      if(material_extra==false){select_material.value=ferreteria_materiales[i]}else{select_material.value="Elegir material."}
      select_material.className="material"
      div_material.appendChild(select_material)
      div_material_marca.appendChild(div_material)

      var div_marca = document.createElement("div")
      var select_marca = crear_select(marcas,marcas_valores)
      if(material_extra==false){select_marca.value=ferreteria_marcas[i]}else{select_marca.value="Cualquier marca"}
      select_marca.className = "marca"
      div_marca.appendChild(select_marca)
      div_material_marca.appendChild(div_marca)

      tabla.appendChild(div_material_marca)

      var div_cantidad = document.createElement("div")
      div_cantidad.className = "item"
      var cantidad = document.createElement("input")
      if(material_extra==false){cantidad.value=ferreteria_precios[i]}else{cantidad.value=0}
      cantidad.className = "quantity_box precio"
      cantidad.type = "number"
      div_cantidad.appendChild(cantidad)
      tabla.appendChild(div_cantidad)
    }

    for(var i=0;i<ferreteria_materiales.length;i++){
      crear_linea_material(lista_materiales,lista_materiales_valores ,lista_marcas, lista_marcas_valores, tabla_materiales,i,false)
    }

    btn_anadir_material.addEventListener('click', (e)=>{
      crear_linea_material(lista_materiales,lista_materiales_valores ,lista_marcas, lista_marcas_valores, tabla_materiales,i,true)
    })

    btn_actualizar_datos.addEventListener('click', (e)=>{

      var conjunto_materiales = document.getElementsByClassName("material")
      var conjunto_marcas = document.getElementsByClassName("marca")
      var conjunto_precios = document.getElementsByClassName("precio")

      update(ref(db, "ferreterias/"+usuario),{
        nombre: nombre_ferreteria.value,
        direccion: direccion.value,
        telefono: telefono.value,
      })


      for(var i=0;i<conjunto_materiales.length;i++){
        set(ref(db, "ferreterias/"+usuario+"/materiales/material"+(i+1)+"/material"),conjunto_materiales[i].value )
        set(ref(db, "ferreterias/"+usuario+"/materiales/material"+(i+1)+"/marca"),conjunto_marcas[i].value )
        set(ref(db, "ferreterias/"+usuario+"/materiales/material"+(i+1)+"/precio"),conjunto_precios[i].value )
      }

      let fm = []
      let fma = []
      let fpro = []
      let fpre = []

      for(var i=0;i<conjunto_materiales.length;i++){
        fm.push(conjunto_materiales[i].value)
        fma.push(conjunto_marcas[i].value)
        fpro.push(conjunto_materiales[i].value+conjunto_marcas[i].value)
        fpre.push(conjunto_precios[i].value)
      }

      sessionStorage.setItem("nombre_ferreteria",nombre_ferreteria.value)
      sessionStorage.setItem("direccion",direccion.value)
      sessionStorage.setItem("telefono",telefono.value)
      sessionStorage.setItem("ferreteria_pruductos",JSON.stringify(fpro))
      sessionStorage.setItem("ferreteria_precios",JSON.stringify(fpre))
      sessionStorage.setItem("ferreteria_materiales",JSON.stringify(fm))
      sessionStorage.setItem("ferreteria_marcas",JSON.stringify(fma))
    
      alert("Datos actualizados correctamente")

    });
    
    
  </script>
    





</body>
</html>