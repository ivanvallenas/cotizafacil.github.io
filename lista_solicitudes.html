<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotiza Fácil</title>
    <link rel="stylesheet" type="text/css" href="css/lista_solicitudes.css">
    <link rel="stylesheet" type="text/css" href="css/main_elements.css">

</head>
<body>

    <section class="container2">

        <div class="container2">
            <div class="container2" >
                <button id="lista_solicitudes" class="main_buttons" onclick="window.location='lista_solicitudes.html'"" style="background-color:rgb(106, 106, 126)">Cotizar</button>
                <button id="lista_cotizaciones_realizadas" class="main_buttons"  onclick="window.location='lista_cotizaciones.html'"">Tus Ofertas</button>
                <button id="lista_materiales" class="main_buttons"  onclick="window.location='lista_materiales.html'"">Tus Materiales</button>
    
            </div>
        </div>


        <div id="titulos_tabla_principal" class="titulos_tabla">
            <a>Código de solicitud</a>
            <a>Pedido</a>
            <a>Precio total </a>
        </div>

        <div id="botones" class="container2"></div>
    </section>

   
    <script type="module">

       

        //Import the database and the principal functions
        import {db} from "./js/firebase.js";   
        import {getDatabase,query, set, get, update, remove, ref, child,onValue}
        from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js"
        //Get only the requests of quotes from the database  
        const parte = query(ref(db,'Solicitudes'))
  



        //Define a varible that makes reference to the div where all the quotes request are going to apear
        var btncon = document.getElementById("botones")
        const usuario = sessionStorage.getItem("usuario")
        const nombre = sessionStorage.getItem("nombre")
        const telefono = sessionStorage.getItem("telefono")

        console.log(telefono)

        console.log(JSON.parse(sessionStorage.getItem("ferreteria_pruductos")))
        console.log(JSON.parse(sessionStorage.getItem("ferreteria_precios")))

        let ferreteria_pruductos = []
        ferreteria_pruductos =JSON.parse(sessionStorage.getItem("ferreteria_pruductos"))

        let ferreteria_precios = []
        ferreteria_precios =JSON.parse(sessionStorage.getItem("ferreteria_precios"))

        
        function valor_de_material(material){
            var precio
            for(var i=0; i<ferreteria_pruductos.length;i++){
                if(ferreteria_pruductos[i]==material){
                    precio=ferreteria_precios[i];
                    break;
                }
                else{
                    precio=0
                }
            }
            return(precio);
        }


        function pedido_completo(m1,p1,m2,p2,m3,p3,m4,p4,m5,p5){
            let p = [p1,p2,p3,p4,p5]
            let m = [m1,m2,m3,m4,m5]
            var materiales_no_disponibles = 0
            var pedido = "Completo"

            for (var i=0; i<p.length; i++) {
                if(m[i]!= "Inicial" && p[i]==0 ){
                    materiales_no_disponibles = materiales_no_disponibles+1
                }
            }

            if(materiales_no_disponibles>0){
                pedido="Incompleto"
            }

            return(pedido)
        }
       
        
        //function to show all the quotes and refresh when a change in the db apears
        onValue(parte, (snapshot) => {
            //first we delete everything inside the div
            btncon.replaceChildren()
            //a snapshot of the data base is created in order to get the data to build the html for each quote request and one expandible element is created for each quote request
            snapshot.forEach((childSnapshot) => {
            
                if (childSnapshot.child(usuario).exists()) {

                }else{ 
                
                var empresa = document.createElement("div")
                var cbt = document.createElement("div")
                var precio = document.createElement("div")
                var pedido = document.createElement("div")
                var ppp = childSnapshot.val().marca1
                console.log(childSnapshot.val().material1+childSnapshot.val().marca1)

                cbt.className="collapsible"

                empresa.className="item"
                empresa.innerHTML=childSnapshot.key
                pedido.className="item"
                precio.className="item"
    

                cbt.appendChild(empresa)
                cbt.appendChild(pedido)
                cbt.appendChild(precio)
                btncon.appendChild(cbt)

                        
                var content = document.createElement("div")
                content.className="content"
                var material_marca1 = document.createElement("div")
                material_marca1.className="item2"
                var material_marca2 = document.createElement("div")
                material_marca2.className="item2"
                var material_marca3 = document.createElement("div")
                material_marca3.className="item2"
                var material_marca4 = document.createElement("div")
                material_marca4.className="item2"
                var material_marca5 = document.createElement("div")
                material_marca5.className="item2"

                var div_precio1 = document.createElement("div")
                div_precio1.className="item"
                var div_precio2 = document.createElement("div")
                div_precio2.className="item"
                var div_precio3 = document.createElement("div")
                div_precio3.className="item"
                var div_precio4 = document.createElement("div")
                div_precio4.className="item"
                var div_precio5 = document.createElement("div")
                div_precio5.className="item"


                var tabla = document.createElement("div")
                tabla.className="table"

                var titulo1 = document.createElement("div")
                titulo1.className="titulo_columna"
                var titulo1_t = document.createElement("p")
                titulo1_t.innerHTML="Material y marca"
                titulo1.appendChild(titulo1_t)
                tabla.appendChild(titulo1)
        
                var titulo3 = document.createElement("div")
                titulo3.className="titulo_columna"
                var titulo3_t = document.createElement("p")
                titulo3_t.innerHTML="Unid"
                titulo3.appendChild(titulo3_t)
                tabla.appendChild(titulo3)

                var titulo4 = document.createElement("div")
                titulo4.className="titulo_columna"
                var titulo4_t = document.createElement("p")
                titulo4_t.innerHTML="Precio"
                titulo4.appendChild(titulo4_t)
                tabla.appendChild(titulo4)

                        
                var m1 = document.createElement("div")
                m1.innerHTML=childSnapshot.val().material1
                material_marca1.appendChild(m1)

                var ma1 = document.createElement("div")
                ma1.innerHTML=childSnapshot.val().marca1
                material_marca1.appendChild(ma1)

                tabla.appendChild(material_marca1)

                var ca1 = document.createElement("div")
                ca1.className="item"
                ca1.innerHTML=childSnapshot.val().cantidad1
                tabla.appendChild(ca1)

                var p1 = document.createElement("input")
                p1.className="quantity_box"
                p1.value=valor_de_material(childSnapshot.val().material1+childSnapshot.val().marca1)*childSnapshot.val().cantidad1
                div_precio1.appendChild(p1)
                tabla.appendChild(div_precio1)



                var m2 = document.createElement("div")
                m2.innerHTML=childSnapshot.val().material2
                material_marca2.appendChild(m2)

                var ma2 = document.createElement("div")
                ma2.innerHTML=childSnapshot.val().marca2
                material_marca2.appendChild(ma2)

                tabla.appendChild(material_marca2)

                var ca2 = document.createElement("div")
                ca2.className="item"
                ca2.innerHTML=childSnapshot.val().cantidad2
                tabla.appendChild(ca2)

                var p2 = document.createElement("input")
                p2.className="quantity_box"
                p2.value=valor_de_material(childSnapshot.val().material2+childSnapshot.val().marca2)*childSnapshot.val().cantidad2
                div_precio2.appendChild(p2)
                tabla.appendChild(div_precio2)



                var m3 = document.createElement("div")
                m3.innerHTML=childSnapshot.val().material3
                material_marca3.appendChild(m3)

                var ma3 = document.createElement("div")
                ma3.innerHTML=childSnapshot.val().marca3
                material_marca3.appendChild(ma3)

                tabla.appendChild(material_marca3)

                var ca3 = document.createElement("div")
                ca3.className="item"
                ca3.innerHTML=childSnapshot.val().cantidad3
                tabla.appendChild(ca3)

                var p3 = document.createElement("input")
                p3.className="quantity_box"
                p3.value=valor_de_material(childSnapshot.val().material3+childSnapshot.val().marca3)*childSnapshot.val().cantidad3
                div_precio3.appendChild(p3)
                tabla.appendChild(div_precio3)



                var m4 = document.createElement("div")
                m4.innerHTML=childSnapshot.val().material4
                material_marca4.appendChild(m4)

                var ma4 = document.createElement("div")
                ma4.innerHTML=childSnapshot.val().marca4
                material_marca4.appendChild(ma4)

                tabla.appendChild(material_marca4)

                var ca4 = document.createElement("div")
                ca4.className="item"
                ca4.innerHTML=childSnapshot.val().cantidad4
                tabla.appendChild(ca4)

                var p4 = document.createElement("input")
                p4.className="quantity_box"
                p4.value=valor_de_material(childSnapshot.val().material4+childSnapshot.val().marca4)*childSnapshot.val().cantidad4
                div_precio4.appendChild(p4)
                tabla.appendChild(div_precio4)



                var m5 = document.createElement("div")
                m5.innerHTML=childSnapshot.val().material5
                material_marca5.appendChild(m5)

                var ma5 = document.createElement("div")
                ma5.innerHTML=childSnapshot.val().marca5
                material_marca5.appendChild(ma5)

                tabla.appendChild(material_marca5)

                var ca5 = document.createElement("div")
                ca5.className="item"
                ca5.innerHTML=childSnapshot.val().cantidad5
                tabla.appendChild(ca5)

                var p5 = document.createElement("input")
                p5.className="quantity_box"
                p5.value=valor_de_material(childSnapshot.val().material5+childSnapshot.val().marca5)*childSnapshot.val().cantidad5
                div_precio5.appendChild(p5)
                tabla.appendChild(div_precio5)

                precio.innerHTML=(Math.floor(p1.value)+Math.floor(p2.value)+Math.floor(p3.value)+Math.floor(p4.value)+Math.floor(p5.value))+" Bs"
                pedido.innerHTML= pedido_completo(m1.innerHTML, p1.value, m2.innerHTML, p2.value, m3.innerHTML, p3.value, m4.innerHTML, p4.value, m5.innerHTML, p5.value)

                content.appendChild(tabla)

                var button_cotizar = document.createElement("button")
                button_cotizar.className="main_buttons2"
                button_cotizar.innerHTML="COTIZAR"
                content.appendChild(button_cotizar)
                button_cotizar.addEventListener("click",function(){

                    set(ref(db, "Solicitudes/"+ childSnapshot.val().codigo_solicitud+"/"+usuario),{
                    precio1: p1.value,

                    })

                    
                    set(ref(db, "Solicitudes/"+childSnapshot.val().codigo_solicitud+"/Cotizaciones/"+usuario),{
                    precio1: p1.value,
                    precio2: p2.value,
                    precio3: p3.value,
                    precio4: p4.value,
                    precio5: p5.value,

                    marca1: ma1.innerHTML,
                    marca2: ma2.innerHTML,
                    marca3: ma3.innerHTML,
                    marca4: ma4.innerHTML,
                    marca5: ma5.innerHTML,

                    cantidad1: ca1.innerHTML,
                    cantidad2: ca2.innerHTML,
                    cantidad3: ca3.innerHTML,
                    cantidad4: ca4.innerHTML,
                    cantidad5: ca5.innerHTML,

                    material1: m1.innerHTML,
                    material2: m2.innerHTML,
                    material3: m3.innerHTML,
                    material4: m4.innerHTML,
                    material5: m5.innerHTML,

                    nombre: nombre,
                    telefono: telefono,
                    pedido: pedido.innerHTML,
                    precio_total: precio.innerHTML,

                    })



                    alert("Cotización enviada")

                })


                btncon.appendChild(content)


            }});
            //This code is for only show the elements with class "content" when the elements with class "collapsible" are clicked
            var coll = document.getElementsByClassName("collapsible");
            var i;
            for (i = 0; i < coll.length; i++) {
                coll[i].addEventListener("click", function() {
                    this.classList.toggle("active");
                    var content = this.nextElementSibling;
                    if (content.style.display === "flex") {
                    content.style.display = "none";
                    } else {
                    content.style.display = "flex";
                    }
                    var valor_total = this.getElementsByClassName("item");
                    var pp = valor_total[2].textContent
                    console.log(pp)
                });
            }    
            

            


        },)
    </script>
    

</body>
</html>